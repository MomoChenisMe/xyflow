.xy-flow {
  --xy-node-color-default: inherit;
  --xy-node-border-default: 1px solid #1a192b;
  --xy-node-background-color-default: #fff;
  --xy-node-group-background-color-default: rgba(240, 240, 240, 0.25);
  --xy-node-boxshadow-hover-default: 0 1px 4px 1px rgba(0, 0, 0, 0.08);
  --xy-node-boxshadow-selected-default: 0 0 0 0.5px #1a192b;
  --xy-node-border-radius-default: 3px;

  --xy-handle-background-color-default: #1a192b;
  --xy-handle-border-color-default: #fff;
  --xy-handle-border-color-connecting: #1a192b;
  --xy-handle-bg-color-connecting: #1a192b;
  --xy-handle-border-color-valid: #4ade80;
  --xy-handle-bg-color-valid: rgba(74, 222, 128, 0.1);
  --xy-handle-border-color-invalid: #ef4444;
  --xy-handle-bg-color-invalid: #ef4444;

  --xy-selection-background-color-default: rgba(0, 89, 220, 0.08);
  --xy-selection-border-default: 1px dotted rgba(0, 89, 220, 0.8);

  --xy-controls-button-background-color-default: #fefefe;
  --xy-controls-button-background-color-hover-default: #f4f4f4;
  --xy-controls-button-color-default: inherit;
  --xy-controls-button-color-hover-default: inherit;
  --xy-controls-button-border-color-default: #eee;
  --xy-controls-box-shadow-default: 0 0 2px 1px rgba(0, 0, 0, 0.08);

  --xy-edge-label-background-color-default: #ffffff;
  --xy-edge-label-color-default: inherit;
  
  /* Edge styles */
  --xy-edge-stroke-default: #b1b1b7;
  --xy-edge-stroke-width-default: 1;
  --xy-edge-stroke-selected-default: #555;
}

.xy-flow.dark {
  --xy-node-color-default: #f8f8f8;
  --xy-node-border-default: 1px solid #3c3c3c;
  --xy-node-background-color-default: #1e1e1e;
  --xy-node-group-background-color-default: rgba(240, 240, 240, 0.25);
  --xy-node-boxshadow-hover-default: 0 1px 4px 1px rgba(255, 255, 255, 0.08);
  --xy-node-boxshadow-selected-default: 0 0 0 0.5px #999;

  --xy-handle-background-color-default: #bebebe;
  --xy-handle-border-color-default: #1e1e1e;
  --xy-handle-border-color-connecting: #bebebe;
  --xy-handle-bg-color-connecting: #bebebe;
  --xy-handle-border-color-valid: #4ade80;
  --xy-handle-bg-color-valid: rgba(74, 222, 128, 0.2);
  --xy-handle-border-color-invalid: #ef4444;
  --xy-handle-bg-color-invalid: #ef4444;

  --xy-selection-background-color-default: rgba(200, 200, 220, 0.08);
  --xy-selection-border-default: 1px dotted rgba(200, 200, 220, 0.8);

  --xy-controls-button-background-color-default: #2b2b2b;
  --xy-controls-button-background-color-hover-default: #3e3e3e;
  --xy-controls-button-color-default: #f8f8f8;
  --xy-controls-button-color-hover-default: #fff;
  --xy-controls-button-border-color-default: #5b5b5b;
  --xy-controls-box-shadow-default: 0 0 2px 1px rgba(0, 0, 0, 0.08);

  --xy-edge-label-background-color-default: #141414;
  --xy-edge-label-color-default: #f8f8f8;
  
  /* Edge styles for dark mode */
  --xy-edge-stroke-default: #3e3e3e;
  --xy-edge-stroke-width-default: 1;
  --xy-edge-stroke-selected-default: #727272;
}

.xy-flow__edge {
  &.updating {
    .xy-flow__edge-path {
      stroke: #777;
    }
  }

  &:is(-text) {
    font-size: 10px;
  }
}

/* Angular XYFlow edge styles */
.angular-xyflow__edge {
  &.selected,
  &:focus,
  &:focus-visible {
    outline: none;
  }

  /* 🔑 修正：使用後代選擇器匹配 SVG 結構 */
  &.selected .angular-xyflow__edge-path,
  &.selectable:focus .angular-xyflow__edge-path,
  &.selectable:focus-visible .angular-xyflow__edge-path {
    stroke: var(--xy-edge-stroke-selected, var(--xy-edge-stroke-selected-default)) !important;
    stroke-width: 1 !important;
  }
  
  /* 🔑 新增：inactive edge 樣式 - 與 React Flow 一致 */
  &.inactive {
    pointer-events: none;
    cursor: default;
    
    .angular-xyflow__edge-path {
      pointer-events: none;
      cursor: default;
    }
    
    .angular-xyflow__edge-interaction {
      pointer-events: none;
    }
  }
  
  /* 🔑 新增：selectable edge 樣式 */
  &.selectable {
    cursor: pointer;
    
    .angular-xyflow__edge-path {
      cursor: pointer;
    }
  }
  
  /* 確保動畫 edge 的互動區域不受動畫影響 */
  &.animated .angular-xyflow__edge-interaction {
    stroke-dasharray: none;
    animation: none;
  }
}

/* Edge path 動畫樣式 */
/* 默認邊樣式 */
.angular-xyflow__edge-path {
  stroke: #b1b1b7;
  stroke-width: 1;
  
  /* 🔑 關鍵修正：多重選中狀態樣式確保生效 */
  &.selected {
    stroke: var(--xy-edge-stroke-selected, var(--xy-edge-stroke-selected-default)) !important;
    stroke-width: 1 !important;
  }
  
  &.animated {
    stroke-dasharray: 5;
    animation: dashdraw 0.5s linear infinite;
    
    /* 動畫邊的選中狀態樣式 */
    &.selected {
      stroke: var(--xy-edge-stroke-selected, var(--xy-edge-stroke-selected-default)) !important;
      stroke-width: 1 !important;
      stroke-dasharray: 5;
      animation: dashdraw 0.5s linear infinite;
    }
  }
}

/* 🔧 額外的強化選擇器 - 多層級保障 */
.angular-xyflow__edge.selected path.angular-xyflow__edge-path,
.angular-xyflow__edge path.angular-xyflow__edge-path.selected,
svg .angular-xyflow__edge-path.selected {
  stroke: var(--xy-edge-stroke-selected, var(--xy-edge-stroke-selected-default)) !important;
  stroke-width: 1 !important;
}

/* Edge label styles */
.angular-xyflow__edge-textbg {
  fill: var(--xy-edge-label-background-color, var(--xy-edge-label-background-color-default));
}

.angular-xyflow__edge-text {
  fill: var(--xy-edge-label-color, var(--xy-edge-label-color-default));
  font-size: 10px;
}


.xy-flow__node.selectable {
  &:focus,
  &:focus-visible {
    outline: none;
  }
}

.xy-flow__node-input,
.xy-flow__node-default,
.xy-flow__node-output,
.xy-flow__node-group {
  position: relative; /* 為 Handle 定位提供參考點 */
  padding: 10px;
  border-radius: var(--xy-node-border-radius, var(--xy-node-border-radius-default));
  width: 150px;
  font-size: 12px;
  color: var(--xy-node-color, var(--xy-node-color-default));
  text-align: center;
  border: var(--xy-node-border, var(--xy-node-border-default));
  background-color: var(--xy-node-background-color, var(--xy-node-background-color-default));

  &.selectable {
    &:hover {
      box-shadow: var(--xy-node-boxshadow-hover, var(--xy-node-boxshadow-hover-default));
    }

    &.selected,
    &:focus,
    &:focus-visible {
      box-shadow: var(--xy-node-boxshadow-selected, var(--xy-node-boxshadow-selected-default));
    }
  }

  /* 🔑 新增：draggable node 樣式 - 與 React Flow 一致 */
  &.draggable {
    cursor: grab;

    &.dragging {
      cursor: grabbing;
    }
  }

  /* 🔑 新增：non-draggable node 樣式 */
  &:not(.draggable) {
    cursor: default;
  }
}


.xy-flow__node-group {
  background-color: var(--xy-node-group-background-color, var(--xy-node-group-background-color-default));
}

.xy-flow__nodesselection-rect,
.xy-flow__selection {
  background: var(--xy-selection-background-color, var(--xy-selection-background-color-default));
  border: var(--xy-selection-border, var(--xy-selection-border-default));

  &:focus,
  &:focus-visible {
    outline: none;
  }
}

.xy-flow__handle {
  position: absolute;
  pointer-events: none; /* 默認不允許點擊，只有在特定狀態下才能點擊 */
  min-width: 5px;
  min-height: 5px;
  width: 6px;
  height: 6px;
  box-sizing: content-box; /* 明確設定為 content-box，與 React Flow 保持一致 */
  background-color: var(--xy-handle-background-color, var(--xy-handle-background-color-default));
  border: 1px solid var(--xy-handle-border-color, var(--xy-handle-border-color-default));
  border-radius: 100%;
  z-index: 10; /* 確保 Handle 顯示在節點內容之上 */
}

.xy-flow__handle.connectingfrom {
  pointer-events: all;
}

.xy-flow__handle.connectionindicator {
  pointer-events: all;
  cursor: crosshair;
}

/* Handle 在可連接狀態下應該能夠點擊 */
.xy-flow__handle.connectable {
  pointer-events: all;
  cursor: crosshair;
}

/* 點擊連接狀態 */
.xy-flow__handle.clickconnecting {
  background-color: var(--xy-handle-border-color-connecting, #1a192b);
  border-color: var(--xy-handle-border-color-connecting, #1a192b);
  box-shadow: 0 0 0 2px rgba(26, 25, 43, 0.3);
}

/* 連接指示器增強 */
.xy-flow__handle.connectionindicator {
  &.connectablestart {
    border-color: var(--xy-handle-border-color-valid, #4ade80);
  }
  
  &.connectableend {
    background-color: var(--xy-handle-bg-color-valid, rgba(74, 222, 128, 0.1));
    border-color: var(--xy-handle-border-color-valid, #4ade80);
  }
}

/* 連接狀態視覺反饋 */
.xy-flow__handle.connectingfrom {
  background-color: var(--xy-handle-bg-color-connecting, #1a192b);
  border-color: var(--xy-handle-border-color-connecting, #1a192b);
  box-shadow: 0 0 0 2px rgba(26, 25, 43, 0.3);
}

.xy-flow__handle.connectingto {
  &.valid {
    background-color: var(--xy-handle-bg-color-valid, #4ade80);
    border-color: var(--xy-handle-border-color-valid, #4ade80);
  }
  
  &.invalid {
    background-color: var(--xy-handle-bg-color-invalid, #ef4444);
    border-color: var(--xy-handle-border-color-invalid, #ef4444);
  }
}

/* 可連接性狀態 */
.xy-flow__handle.connectablestart {
  cursor: pointer;
}

.xy-flow__handle.connectableend {
  cursor: crosshair;
}

.xy-flow__handle-bottom {
  top: auto;
  left: 50%;
  bottom: 0;
  transform: translate(-50%, 50%);
}

.xy-flow__handle-top {
  top: 0;
  left: 50%;
  transform: translate(-50%, -50%);
}

.xy-flow__handle-left {
  top: var(--handle-offset-y, 50%);
  left: 0;
  transform: translate(-50%, -50%);
}

.xy-flow__handle-right {
  top: var(--handle-offset-y, 50%);
  right: 0;
  transform: translate(50%, -50%);
}

.xy-flow__controls {
  box-shadow: var(--xy-controls-box-shadow, var(--xy-controls-box-shadow-default));

  &:is(-button) {
    border: none;
    background: var(--xy-controls-button-background-color, var(--xy-controls-button-background-color-default));
    border-bottom: 1px solid
      var(
        --xy-controls-button-border-color-props,
        var(--xy-controls-button-border-color, var(--xy-controls-button-border-color-default))
      );
    color: var(
      --xy-controls-button-color-props,
      var(--xy-controls-button-color, var(--xy-controls-button-color-default))
    );
    cursor: pointer;
    user-select: none;

    &:hover {
      background: var(
        --xy-controls-button-background-color-hover-props,
        var(--xy-controls-button-background-color-hover, var(--xy-controls-button-background-color-hover-default))
      );
      color: var(
        --xy-controls-button-color-hover-props,
        var(--xy-controls-button-color-hover, var(--xy-controls-button-color-hover-default))
      );
    }

    &:disabled {
      pointer-events: none;

      svg {
        fill-opacity: 0.4;
      }
    }
  }

  &:is(-button):last-child {
    border-bottom: none;
  }

  &.horizontal :is(.xy-flow__controls-button) {
    border-bottom: none;
    border-right: 1px solid
      var(
        --xy-controls-button-border-color-props,
        var(--xy-controls-button-border-color, var(--xy-controls-button-border-color-default))
      );
  }

  &.horizontal :is(.xy-flow__controls-button):last-child {
    border-right: none;
  }
}

/* Intersection Example - Highlight 樣式 */
.angular-xyflow__node.highlight {
  background-color: #ff5050 !important;
  color: white !important;
  
  /* 確保與 React 版本視覺效果一致 */
  transition: background-color 0.2s ease;
}

/* 針對不同節點類型的高亮樣式 */
.angular-xyflow__node-default.highlight,
.angular-xyflow__node-input.highlight,
.angular-xyflow__node-output.highlight {
  background-color: #ff5050 !important;
  color: white !important;
}
